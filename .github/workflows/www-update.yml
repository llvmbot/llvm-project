name: Update Website

on:
  push:
        
jobs:
  clang_www:
    name: Update website
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: sudo apt-get install ninja-build
      # Install using pip so we can get a newer version.
      - Name: Install sphinx
        run: sudo pip install sphinx
      - name: Download source code
        uses: llvm/actions/get-llvm-project-src@master
        with:
          ref: ${{ github.sha }}
          repo: ${{ github.repository }}
      - name: Build documentation
        run: |
          mkdir build
          cd build
          cmake ../llvm -G Ninja -DLLVM_ENABLE_PROJECTS="clang;lld" -DLLVM_ENABLE_SPHINX=ON -DSPHINX_WARNINGS_AS_ERRORS=OFF
          ninja docs-clang-html docs-lld-html

      - name: Setup git
        run: |
          git config --global user.name "llvmbot"
          git config --global user.email "llvmbot@llvm.org"

      - name: Clone and prep website repos
        run: |
          for repo in clang-www lld-www; do
            git clone https://${WWW_TOKEN}@github.com/llvmbot/${repo}
            pushd ${repo}
            git rm -r *
            popd
          done
        env:
          WWW_TOKEN: ${{ secrets.WWW_TOKEN }}

      - name: Update clang-www
        run: |
          cp -R clang/www/. clang-www/
          mkdir -p clang-www/docs
          cp -R build/tools/clang/docs/html/. clang-www/docs/
          
      - name: Update lld-www
        run: |
          ls -a build/tools/lld/docs/html/
          cp -Rv build/tools/lld/docs/html/. lld-www/
          ls -a lld-www/

      - name: Push changes to www repos
        run: |
          for repo in clang-www lld-www; do
            pushd ${repo}
            git add .
            if ! git diff --cached --exit-code; then
              git commit -a -m "Update documentation from commit $GITHUB_SHA"
              git push origin master:master
            fi
            popd
          done
